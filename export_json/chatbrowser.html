<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©è®°å½•æµè§ˆå™¨</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500&display=swap');
        
        :root {
            --body-bg: #EDEDED;
            --app-bg: #FFFFFF;
            --header-bg: #F7F7F7;
            --bubble-self-bg: #95EC69;
            --bubble-other-bg: #FFFFFF;
            --text-primary: #1A1A1A;
            --text-secondary: #B2B2B2;
            --border-color: #E0E0E0;
            --accent-color: #07C160;
            --sidebar-bg: #F7F7F7;
            --sidebar-width: 250px;
            --toolbar-width: 300px;
        }
        body {
            background-color: var(--body-bg);
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }
        #app-container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background-color: var(--app-bg); 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 0 20px rgba(0,0,0,0.05); 
        }
        #file-selector-container { 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            text-align: center; 
            padding: 60px 20px; 
            flex-grow: 1; 
        }
        #file-selector-container h2 { 
            font-size: 1.5em; 
            color: var(--text-primary); 
            font-weight: 500; 
            margin-bottom: 30px; 
        }
        #file-input-label { 
            background-color: var(--accent-color); 
            color: white; 
            padding: 14px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1.1em; 
            font-weight: 500; 
            transition: all 0.2s ease-in-out; 
            box-shadow: 0 4px 10px rgba(7, 193, 96, 0.2); 
        }
        #file-input-label:hover { 
            background-color: #06ad56; 
            transform: translateY(-2px); 
            box-shadow: 0 6px 15px rgba(7, 193, 96, 0.3); 
        }
        #file-input { display: none; }
        #chat-header { 
            text-align: center; 
            padding: 12px; 
            border-bottom: 1px solid var(--border-color); 
            background-color: rgba(247, 247, 247, 0.8); 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            backdrop-filter: blur(10px); 
            display: none; 
        }
        #chat-title { 
            margin: 0; 
            font-size: 1em; 
            font-weight: 500; 
            color: var(--text-primary); 
        }
        #main-container {
            display: flex;
            flex-direction: row;
            flex-grow: 1;
            overflow: hidden;
        }
        #chat-container { 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 50px;
        }
        
        /* æ—¶é—´åˆ†å‰²çº¿æ ·å¼ */
        .time-divider {
            text-align: center;
            margin: 15px 0;
        }
        .time-divider span {
            background-color: #DADADA;
            color: #FFFFFF;
            font-size: 0.8em;
            padding: 4px 10px;
            border-radius: 12px;
        }
        .time-divider a {
            background-color: #DADADA;
            color: #FFFFFF;
            font-size: 0.8em;
            padding: 4px 10px;
            border-radius: 12px;
            text-decoration: none;
        }
        .message { display: flex; flex-direction: column; max-width: 75%; margin-top: 10px; }
        .message-bubble { padding: 12px 16px; border-radius: 20px; line-height: 1.6; word-wrap: break-word; font-size: 16px; }
        .message-bubble img { max-width: 100%; border-radius: 10px; }
        .sender-name { font-size: 0.8em; color: var(--text-secondary); margin-bottom: 6px; }
        .other { align-self: flex-start; }
        .other .message-bubble { background-color: var(--bubble-other-bg); border: 1px solid var(--border-color); border-top-left-radius: 4px; }
        .other .sender-name { margin-left: 10px; }
        .self { align-self: flex-end; }
        .self .message-bubble { background-color: var(--bubble-self-bg); border-top-right-radius: 4px; }
        .self .sender-name { display: none; }
        .app-card { display: block; text-decoration: none; color: inherit; padding: 12px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; }
        .app-card-title { font-weight: 500; font-size: 1em; margin-bottom: 8px; }
        .app-card-desc { font-size: 0.9em; color: var(--text-secondary); margin: 0; }
        .placeholder-text { font-style: italic; color: var(--text-secondary); }
        .empty-message {
            font-style: italic;
            color: #999;
            background-color: #f5f5f5;
        }
        .emoji-container {
            display: inline-block;
            font-size: 18px;
            vertical-align: middle;
        }
        .emoji-type {
            font-style: italic;
            color: #666;
            font-size: 14px;
        }
        .highlight {
            background-color: yellow;
            font-weight: bold;
        }
        .message-highlight {
            animation: highlight 2s;
        }
        @keyframes highlight {
            0% { background-color: yellow; }
            100% { background-color: transparent; }
        }
        
        /* å·¥å…·æ æ ·å¼ */
        #toolbar-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 1000;
            font-size: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        #toolbar-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        #toolbar {
            position: fixed;
            top: 0;
            right: 0;
            width: var(--toolbar-width);
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 999;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        #toolbar.open {
            transform: translateX(0);
        }
        
        #toolbar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #toolbar-header h2 {
            margin: 0;
            font-size: 1.2em;
            color: var(--text-primary);
        }
        
        #toolbar-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        #toolbar-close:hover {
            background: #f0f0f0;
        }
        
        #toolbar-content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        #search-container, #time-index-container {
            margin-bottom: 30px;
        }
        
        #search-container h3, #time-index-container h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1em;
            color: var(--text-primary);
        }
        
        #search-box, #time-search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        
        #search-results, #time-search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }
        
        .search-result, .time-search-result {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-result:hover, .time-search-result:hover {
            background-color: #f0f0f0;
        }
        
        .search-result:last-child, .time-search-result:last-child {
            border-bottom: none;
        }
        
        #time-index {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }
        
        .time-link {
            display: block;
            padding: 10px;
            text-decoration: none;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }
        
        .time-link:hover {
            background-color: #f0f0f0;
        }
        
        .time-link:last-child {
            border-bottom: none;
        }
        
        /* é®ç½©å±‚ */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 998;
            display: none;
        }
        
        #overlay.show {
            display: block;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="file-selector-container">
            <h2>æ¬¢è¿ä½¿ç”¨èŠå¤©è®°å½•æµè§ˆå™¨</h2>
            <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                <label for="file-input" id="file-input-label">é€‰æ‹© JSON æ–‡ä»¶</label>
                <input type="file" id="file-input" accept=".json">
                <button id="image-dir-button" style="background-color: #f0f0f0; color: #333; padding: 14px 24px; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: 500; border: 1px solid #ccc; transition: all 0.2s ease-in-out;">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶å¤¹ (å¯é€‰)</button>
            </div>
        </div>
        <div id="chat-header"><h1 id="chat-title"></h1></div>
        <button id="toolbar-toggle">â˜°</button>
        <div id="toolbar">
            <div id="toolbar-header">
                <h2>å·¥å…·ç®±</h2>
                <button id="toolbar-close">&times;</button>
            </div>
            <div id="toolbar-content">
                <div id="search-container">
                    <h3>æœç´¢</h3>
                    <input type="text" id="search-box" placeholder="æœç´¢èŠå¤©è®°å½•...">
                    <div id="search-results"></div>
                </div>
                <div id="time-index-container">
                    <h3>æ—¶é—´ç´¢å¼•</h3>
                    <input type="text" id="time-search-box" placeholder="æœç´¢æ—¥æœŸ...">
                    <div id="time-search-results"></div>
                    <div id="time-index"></div>
                </div>
                <div id="image-settings-container" style="margin-bottom: 30px;">
                    <h3>å›¾ç‰‡è®¾ç½®</h3>
                    <button id="toolbar-image-dir-button" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; cursor: pointer; background-color: #f0f0f0;">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶å¤¹</button>
                    <p id="image-dir-status" style="font-size: 0.8em; color: var(--text-secondary); margin-top: 8px; text-align: center;">å½“å‰æœªé€‰æ‹©æ–‡ä»¶å¤¹</p>
                </div>
            </div>
        </div>
        <div id="overlay"></div>
        <div id="chat-container"></div>
    </div>
    <script>
        // JavaScript V8.0 - ç»ˆæå…¸è—ç‰ˆï¼Œå¢åŠ æ™ºèƒ½æ—¶é—´æˆ³å’Œè¡¨æƒ…æ¸²æŸ“
        const parser = new DOMParser();
        let allMessages = [];
        let timeIndex = []; // å­˜å‚¨æ—¶é—´ç´¢å¼•
        let imageDirectoryHandle = null;
        
        // è¡¨æƒ…æ˜ å°„è¡¨ - å°†æ–‡æœ¬è¡¨æƒ…è½¬æ¢ä¸ºå®é™…è¡¨æƒ…
        const emojiMap = {
            "[å¾®ç¬‘]": "ğŸ˜Š",
            "[å¥¸ç¬‘]": "ğŸ˜",
            "[ç¬‘å“­]": "ğŸ˜‚",
            "[çˆ±å¿ƒ]": "â¤ï¸",
            "[ç‚¹èµ]": "ğŸ‘",
            "[éš¾è¿‡]": "ğŸ˜¢",
            "[æƒŠè®¶]": "ğŸ˜®",
            "[è°ƒçš®]": "ğŸ˜œ",
            "[å‘²ç‰™]": "ğŸ˜",
            "[ç–‘é—®]": "â“",
            "[å¥‹æ–—]": "ğŸ’ª",
            "[æŠ±æ‹³]": "ğŸ™",
            "[OK]": "ğŸ‘Œ",
            "[å¼±]": "ğŸ˜©",
            "[è€¶]": "ğŸ˜",
            "[åŠ æ²¹]": "ğŸ’¦",
            "[åƒç“œ]": "ğŸ‰",
            "[å›°]": "ğŸ˜´",
            "[æ±—]": "ğŸ˜°",
            "[å°´å°¬]": "ğŸ˜…",
            "[æŠ é¼»]": "ğŸ¤”",
            "[é¼“æŒ]": "ğŸ‘",
            "[å‘æ€’]": "ğŸ˜ ",
            "[æµæ³ª]": "ğŸ˜­",
            "[æ‚è„¸]": "ğŸ¤¦",
            "[æœºæ™º]": "ğŸ¤“",
            "[åƒç‹—ç²®]": "ğŸ¶",
            "[æ—ºæŸ´]": "ğŸ¶",
            "[ç‹—å¤´]": "ğŸ¶",
            "[è®©æˆ‘çœ‹çœ‹]": "ğŸ‘€",
            "[ç¤¾ä¼šç¤¾ä¼š]": "ğŸ¤",
            "[å“‡]": "ğŸ˜²",
            "[å˜˜]": "ğŸ¤«",
            "[è£‚å¼€]": "ğŸ˜µ",
            "[è‹¦æ¶©]": "ğŸ˜£",
            "[å‘æŠ–]": "ğŸ˜¨",
            "[æ•¬ç¤¼]": "ğŸ«¡",
            "[666]": "ğŸ‘ğŸ‘ğŸ‘",
            "[è®©æˆ‘åº·åº·]": "ğŸ‘€",
            "[å¹²é¥­]": "ğŸš",
            "[å¹æ°”]": "ğŸ˜”",
            "[å˜¿å“ˆ]": "ğŸ˜„",
            "[æ‚è„¸å“­]": "ğŸ¥º",
            "[çš±çœ‰]": "ğŸ˜Ÿ",
            "[å¤©å•Š]": "ğŸ˜±",
            "[Emm]": "ğŸ¤”",
            "[å¥½çš„]": "ğŸ‘Œ",
            "[æ‰“è„¸]": "ğŸ¤¦",
            "[ç¿»ç™½çœ¼]": "ğŸ™„",
            "[å˜´å”‡]": "ğŸ‘„",
            "[å¿ƒç¢]": "ğŸ’”",
            "[æ‹¥æŠ±]": "ğŸ¤—",
            "[å¼º]": "ğŸ’ª",
            "[å¼±]": "ğŸ‘",
            "[æ¡æ‰‹]": "ğŸ¤",
            "[èƒœåˆ©]": "âœŒï¸",
            "[å‹¾å¼•]": "ğŸ˜",
            "[æ‹³å¤´]": "ğŸ‘Š",
            "[åˆå]": "ğŸ™",
            "[å•¤é…’]": "ğŸº",
            "[å’–å•¡]": "â˜•",
            "[è›‹ç³•]": "ğŸ‚",
            "[ç«ç‘°]": "ğŸŒ¹",
            "[å‡‹è°¢]": "ğŸ¥€",
            "[èœåˆ€]": "ğŸ”ª",
            "[ç‚¸å¼¹]": "ğŸ’£",
            "[ä¾¿ä¾¿]": "ğŸ’©",
            "[æœˆäº®]": "ğŸŒ™",
            "[å¤ªé˜³]": "â˜€ï¸",
            "[åº†ç¥]": "ğŸ‰",
            "[ç¤¼ç‰©]": "ğŸ",
            "[çº¢åŒ…]": "ğŸ§§",
            "[ç™¼]": "ğŸ’°",
            "[ç¦]": "ğŸ§§",
            "[çƒŸèŠ±]": "ğŸ†",
            "[çˆ†ç«¹]": "ğŸ§¨",
            "[é¸¡]": "ğŸ”",
            "[ç‹—]": "ğŸ¶",
            "[çŒª]": "ğŸ·",
            "[é¼ ]": "ğŸ­",
            "[ç‰›]": "ğŸ®",
            "[è™]": "ğŸ¯",
            "[å…”]": "ğŸ°",
            "[é¾™]": "ğŸ²",
            "[è›‡]": "ğŸ",
            "[é©¬]": "ğŸ´",
            "[ç¾Š]": "ğŸ‘",
            "[çŒ´]": "ğŸµ",
            "[é¸¡]": "ğŸ”",
            "[ç‹—]": "ğŸ¶",
            "[çŒª]": "ğŸ·"
        };
        
        // è¡¨æƒ…ç±»å‹æ˜ å°„è¡¨
        const emojiTypeMap = {
            "1": "[å†…ç½®è¡¨æƒ…]",  // å†…ç½®è¡¨æƒ…
            "2": "[è‡ªå®šä¹‰è¡¨æƒ…]",  // è‡ªå®šä¹‰è¡¨æƒ…/è´´çº¸
            "3": "[GIF]"   // åŠ¨ç”»è¡¨æƒ…
        };
        
        function formatTimestamp(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const h = String(date.getHours()).padStart(2, '0');
            const min = String(date.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${d} ${h}:${min}`;
        }
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        function parseXmlAndGetData(xmlString) {
            try {
                const cleanedXml = xmlString.replace(/\u0000/g, '').trim();
                const xmlDoc = parser.parseFromString(cleanedXml, "text/xml");
                const title = xmlDoc.querySelector("title")?.textContent.trim();
                const desc = xmlDoc.querySelector("desc")?.textContent.trim();
                return { title, desc };
            } catch (e) {
                console.error("XMLè§£æå¤±è´¥:", e, "åŸå§‹å†…å®¹:", xmlString);
                return null;
            }
        }
        async function renderMessage(msg) {
            console.log("[DEBUG] å¼€å§‹æ¸²æŸ“æ¶ˆæ¯ - ç±»å‹:", msg.type, "å†…å®¹é¢„è§ˆ:", msg.content?.substring(0, 50) || 'æ— å†…å®¹', "å›¾ç‰‡è·¯å¾„:", msg.imagePath || 'æ— ');
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('message-bubble');
            
            // æ£€æŸ¥æ¶ˆæ¯å†…å®¹æ˜¯å¦ä¸ºç©º
            if (!msg.content || msg.content.trim() === '') {
                console.warn("å‘ç°ç©ºæ¶ˆæ¯:", msg); // æ·»åŠ è­¦å‘Šæ—¥å¿—
                bubbleDiv.textContent = '[ç©ºæ¶ˆæ¯]';
                bubbleDiv.classList.add('empty-message');
                return bubbleDiv;
            }
            
            switch (msg.type) {
                case 3: // Image
                    console.log("[DEBUG] å¤„ç†å›¾ç‰‡æ¶ˆæ¯ - å›¾ç‰‡è·¯å¾„:", msg.imagePath || 'æœªæä¾›');
                    if (msg.imagePath && imageDirectoryHandle) {
                        console.log("[DEBUG] å°è¯•ä»é€‰æ‹©çš„æ–‡ä»¶å¤¹åŠ è½½å›¾ç‰‡:", msg.imagePath);
                        try {
                            const fileHandle = await imageDirectoryHandle.getFileHandle(msg.imagePath, { create: false });
                            const file = await fileHandle.getFile();
                            const imageSrc = URL.createObjectURL(file);
                            console.log("[DEBUG] å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œåˆ›å»ºå¯¹è±¡URL:", imageSrc);
                            bubbleDiv.innerHTML = `<img src="${imageSrc}" alt="Image" style="max-width: 100%; border-radius: 10px;" onload="console.log('[DEBUG] å›¾ç‰‡æ¸²æŸ“å®Œæˆ:', this.src); setTimeout(() => { URL.revokeObjectURL(this.src); console.log('[DEBUG] å·²é‡Šæ”¾å›¾ç‰‡èµ„æº:', this.src); }, 5000);" onerror="console.error('[DEBUG] å›¾ç‰‡æ¸²æŸ“å¤±è´¥:', this.src, event)">`;
                        } catch (err) {
                            console.error(`[DEBUG] æ— æ³•ä»é€‰æ‹©çš„æ–‡ä»¶å¤¹åŠ è½½å›¾ç‰‡: ${msg.imagePath}`, err);
                            bubbleDiv.textContent = `[å›¾ç‰‡åŠ è½½å¤±è´¥: ${msg.imagePath}]`;
                        }
                    } else if (msg.imagePath) {
                        console.log("[DEBUG] å›¾ç‰‡è·¯å¾„å­˜åœ¨ï¼Œä½†æœªé€‰æ‹©æ–‡ä»¶å¤¹");
                        bubbleDiv.textContent = '[å›¾ç‰‡ (è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶å¤¹)]';
                    } else {
                        console.log("[DEBUG] æ— å›¾ç‰‡è·¯å¾„ï¼Œæ˜¾ç¤ºå ä½ç¬¦");
                        bubbleDiv.textContent = '[å›¾ç‰‡]';
                    }
                    break;
                case 1:
                    console.log("å¤„ç†æ–‡æœ¬æ¶ˆæ¯:", msg.content); // æ·»åŠ æ—¥å¿—
                    
                    // å¤„ç†æ–‡æœ¬æ¶ˆæ¯ä¸­çš„è¡¨æƒ…
                    let textContent = msg.content;
                    // æŸ¥æ‰¾æ‰€æœ‰è¡¨æƒ…æ ¼å¼å¹¶æ›¿æ¢
                    const emojiRegex = /\[([^\]]+)\]/g;
                    let match;
                    let lastIndex = 0;
                    let resultHTML = '';
                    
                    while ((match = emojiRegex.exec(textContent)) !== null) {
                        // æ·»åŠ è¡¨æƒ…å‰çš„æ–‡æœ¬
                        resultHTML += textContent.substring(lastIndex, match.index);
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯è¡¨æƒ…
                        if (emojiMap[match[0]]) {
                            // æ·»åŠ è¡¨æƒ…ç¬¦å·
                            resultHTML += emojiMap[match[0]];
                            console.log("æ–‡æœ¬ä¸­çš„è¡¨æƒ…æ˜ å°„:", match[0], "->", emojiMap[match[0]]); // æ·»åŠ æ—¥å¿—
                        } else {
                            // ä¸æ˜¯è¡¨æƒ…ï¼Œä¿æŒåŸæ ·
                            resultHTML += match[0];
                            console.log("æ–‡æœ¬ä¸­çš„éè¡¨æƒ…:", match[0]); // æ·»åŠ æ—¥å¿—
                        }
                        
                        lastIndex = match.index + match[0].length;
                    }
                    
                    // æ·»åŠ å‰©ä½™æ–‡æœ¬
                    resultHTML += textContent.substring(lastIndex);
                    
                    bubbleDiv.innerHTML = resultHTML;
                    break;
                case 47:
                    console.log("å¤„ç†è¡¨æƒ…æ¶ˆæ¯:", msg.content); // æ·»åŠ æ—¥å¿—
                    // è¡¨æƒ…æ¶ˆæ¯å¤„ç†
                    let emojiContent = msg.content;
                    let emojiDisplay = '[è¡¨æƒ…]'; // é»˜è®¤æ˜¾ç¤º
                    
                    // é¦–å…ˆå°è¯•è§£æXMLæ ¼å¼çš„è¡¨æƒ…
                    if (emojiContent.includes('<emoji')) {
                        try {
                            const xmlDoc = parser.parseFromString(emojiContent, "text/xml");
                            const emojiElement = xmlDoc.querySelector("emoji");
                            if (emojiElement) {
                                // å°è¯•ä»XMLå±æ€§ä¸­è·å–è¡¨æƒ…ä¿¡æ¯
                                const type = emojiElement.getAttribute("type");
                                const desc = emojiElement.getAttribute("desc") || emojiElement.getAttribute("attachedtext");
                                const md5 = emojiElement.getAttribute("md5");
                                
                                console.log("XMLè¡¨æƒ…å±æ€§:", { type, desc, md5 }); // æ·»åŠ æ—¥å¿—
                                
                                if (desc) {
                                    // å¦‚æœæœ‰æè¿°ï¼Œå°è¯•æ˜ å°„ä¸ºè¡¨æƒ…ç¬¦å·
                                    const descMatch = desc.match(/\[([^\]]+)\]/);
                                    if (descMatch && emojiMap[descMatch[0]]) {
                                        emojiDisplay = emojiMap[descMatch[0]];
                                        console.log("XMLè¡¨æƒ…æ˜ å°„:", descMatch[0], "->", emojiDisplay); // æ·»åŠ æ—¥å¿—
                                    } else {
                                        // å¦‚æœæ²¡æœ‰æ˜ å°„ï¼Œæ˜¾ç¤ºæè¿°
                                        emojiDisplay = desc;
                                        console.log("XMLè¡¨æƒ…æè¿°:", desc); // æ·»åŠ æ—¥å¿—
                                    }
                                } else if (type && emojiTypeMap[type]) {
                                    // å¦‚æœæœ‰ç±»å‹ä¿¡æ¯ï¼Œå¹¶ä¸”æœ‰å¯¹åº”çš„æ˜ å°„
                                    emojiDisplay = `<span class="emoji-type">${emojiTypeMap[type]}</span>`;
                                    console.log("XMLè¡¨æƒ…ç±»å‹æ˜ å°„:", type, "->", emojiDisplay); // æ·»åŠ æ—¥å¿—
                                } else if (type) {
                                    // å¦‚æœæœ‰ç±»å‹ä¿¡æ¯ï¼Œä½†æ²¡æœ‰æ˜ å°„ï¼Œæ˜¾ç¤ºç±»å‹
                                    emojiDisplay = '<span class="emoji-type">[è¡¨æƒ…]</span>';
                                    console.log("XMLè¡¨æƒ…ç±»å‹:", type); // æ·»åŠ æ—¥å¿—
                                } else if (md5) {
                                    // å¦‚æœæœ‰MD5ï¼Œå¯èƒ½æ˜¯è‡ªå®šä¹‰è¡¨æƒ…
                                    emojiDisplay = '<span class="emoji-type">[è‡ªå®šä¹‰è¡¨æƒ…]</span>';
                                    console.log("XMLè‡ªå®šä¹‰è¡¨æƒ…MD5:", md5); // æ·»åŠ æ—¥å¿—
                                } else {
                                    // å¦‚æœéƒ½æ²¡æœ‰ï¼Œæ˜¾ç¤ºé€šç”¨è¡¨æƒ…å ä½ç¬¦
                                    emojiDisplay = '<span class="emoji-type">[è¡¨æƒ…]</span>';
                                    console.log("XMLè¡¨æƒ…æ— æè¿°å’Œç±»å‹"); // æ·»åŠ æ—¥å¿—
                                }
                            }
                        } catch (e) {
                            console.error("XMLè¡¨æƒ…è§£æå¤±è´¥:", e, "åŸå§‹å†…å®¹:", emojiContent); // æ·»åŠ é”™è¯¯æ—¥å¿—
                            emojiDisplay = '<span class="emoji-type">[è¡¨æƒ…]</span>';
                        }
                    } else {
                        // å¤„ç†éXMLæ ¼å¼çš„è¡¨æƒ…ï¼ˆå¦‚[å¾®ç¬‘]ï¼‰
                        let emojiDisplay = emojiContent; // é»˜è®¤æ˜¾ç¤ºåŸå§‹å†…å®¹
                        
                        // æ£€æŸ¥å†…å®¹æ˜¯å¦åŒ…å«è¡¨æƒ…æè¿°æ ¼å¼
                        const emojiMatch = emojiContent.match(/\[([^\]]+)\]/);
                        if (emojiMatch && emojiMap[emojiMatch[0]]) {
                            // å¦‚æœåœ¨æ˜ å°„è¡¨ä¸­ï¼Œä½¿ç”¨å¯¹åº”çš„è¡¨æƒ…ç¬¦å·
                            emojiDisplay = emojiMap[emojiMatch[0]];
                            console.log("è¡¨æƒ…æ˜ å°„:", emojiMatch[0], "->", emojiDisplay); // æ·»åŠ æ—¥å¿—
                        } else {
                            console.log("æœªæ‰¾åˆ°è¡¨æƒ…æ˜ å°„:", emojiMatch ? emojiMatch[0] : "æ— åŒ¹é…é¡¹"); // æ·»åŠ æ—¥å¿—
                        }
                    }
                    
                    // åˆ›å»ºè¡¨æƒ…å®¹å™¨
                    const emojiContainer = document.createElement('span');
                    emojiContainer.className = 'emoji-container';
                    emojiContainer.innerHTML = emojiDisplay;
                    bubbleDiv.appendChild(emojiContainer);
                    break;
                case 49:
                    console.log("å¤„ç†åˆ†äº«/å¼•ç”¨æ¶ˆæ¯:", msg.content, "å­ç±»å‹:", msg.subType); // æ·»åŠ æ—¥å¿—
                    // å¼•ç”¨æ¶ˆæ¯å¤„ç† - ç›´æ¥æ˜¾ç¤ºå†…å®¹
                    if (msg.subType === 57) {
                        console.log("å¤„ç†å¼•ç”¨æ¶ˆæ¯:", msg.content); // æ·»åŠ æ—¥å¿—
                        bubbleDiv.textContent = msg.content;
                    } else {
                        // å…¶ä»–ç±»å‹çš„åˆ†äº«æ¶ˆæ¯
                        console.log("å¤„ç†å…¶ä»–åˆ†äº«æ¶ˆæ¯:", msg.content); // æ·»åŠ æ—¥å¿—
                        const cardData = parseXmlAndGetData(msg.content);
                        if (cardData && cardData.title) {
                            console.log("åˆ†äº«æ¶ˆæ¯è§£ææˆåŠŸ:", cardData); // æ·»åŠ æ—¥å¿—
                            bubbleDiv.style.padding = '0';
                            bubbleDiv.style.background = 'none';
                            bubbleDiv.style.border = 'none';
                            bubbleDiv.innerHTML = `
                                <div class="app-card">
                                    <div class="app-card-title">${cardData.title}</div>
                                    ${cardData.desc ? `<p class="app-card-desc">${cardData.desc}</p>` : ''}
                                </div>
                            `;
                        } else {
                            console.warn("åˆ†äº«æ¶ˆæ¯è§£æå¤±è´¥ï¼Œæ˜¾ç¤ºåŸå§‹å†…å®¹"); // æ·»åŠ è­¦å‘Šæ—¥å¿—
                            // å¦‚æœXMLè§£æå¤±è´¥ï¼Œå°è¯•ä½œä¸ºæ™®é€šæ–‡æœ¬æ˜¾ç¤º
                            bubbleDiv.textContent = msg.content;
                        }
                    }
                    break;
                default:
                    console.warn("å¤„ç†æœªçŸ¥ç±»å‹æ¶ˆæ¯:", msg.type, msg.typeDesc, msg.content); // æ·»åŠ è­¦å‘Šæ—¥å¿—
                    bubbleDiv.textContent = `[${msg.typeDesc || `æœªçŸ¥ç±»å‹: ${msg.type}`}]`;
                    bubbleDiv.classList.add('placeholder-text');
                    break;
            }
            
            // æ£€æŸ¥æ¸²æŸ“åçš„å†…å®¹æ˜¯å¦ä¸ºç©º
            if (bubbleDiv.textContent.trim() === '' && bubbleDiv.children.length === 0) {
                console.warn("æ¸²æŸ“åå†…å®¹ä¸ºç©º:", msg); // æ·»åŠ è­¦å‘Šæ—¥å¿—
                bubbleDiv.textContent = '[ç©ºæ¶ˆæ¯]';
                bubbleDiv.classList.add('empty-message');
            }
            
            return bubbleDiv;
        }
        // æ„å»ºæ—¶é—´ç´¢å¼•
        function buildTimeIndex(messages) {
            console.log("æ„å»ºæ—¶é—´ç´¢å¼•ï¼Œæ¶ˆæ¯æ•°é‡:", messages.length); // æ·»åŠ æ—¥å¿—
            timeIndex = [];
            const dateMap = new Map();
            
            messages.forEach((msg, index) => {
                const date = new Date(msg.time);
                const dateStr = formatDate(date);
                
                if (!dateMap.has(dateStr)) {
                    dateMap.set(dateStr, {
                        date: dateStr,
                        timestamp: date.getTime(),
                        firstIndex: index,
                        displayText: formatTimestamp(date)
                    });
                }
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ—¶é—´æ’åº
            timeIndex = Array.from(dateMap.values()).sort((a, b) => a.timestamp - b.timestamp);
            console.log("æ—¶é—´ç´¢å¼•æ„å»ºå®Œæˆï¼Œç´¢å¼•æ•°é‡:", timeIndex.length); // æ·»åŠ æ—¥å¿—
            renderTimeIndex();
        }
        // æœç´¢æ—¶é—´ç´¢å¼•
        function searchTimeIndex(keyword) {
            console.log("æœç´¢æ—¶é—´ç´¢å¼•:", keyword); // æ·»åŠ æ—¥å¿—
            const resultsContainer = document.getElementById('time-search-results');
            resultsContainer.innerHTML = '';
            
            if (!keyword) {
                resultsContainer.style.display = 'none';
                document.getElementById('time-index').style.display = 'block';
                return;
            }
            
            const results = timeIndex.filter(item => 
                item.date.includes(keyword) || item.displayText.includes(keyword)
            );
            
            console.log("æ—¶é—´ç´¢å¼•æœç´¢ç»“æœ:", results.length); // æ·»åŠ æ—¥å¿—
            
            if (results.length > 0) {
                results.forEach(result => {
                    const resultElement = document.createElement('div');
                    resultElement.className = 'time-search-result';
                    resultElement.textContent = result.displayText;
                    resultElement.dataset.index = result.firstIndex;
                    resultElement.addEventListener('click', (e) => {
                        scrollToMessage(parseInt(e.target.dataset.index));
                        toggleToolbar();
                        resultsContainer.style.display = 'none';
                        document.getElementById('time-index').style.display = 'block';
                    });
                    resultsContainer.appendChild(resultElement);
                });
                resultsContainer.style.display = 'block';
                document.getElementById('time-index').style.display = 'none';
            } else {
                resultsContainer.style.display = 'none';
                document.getElementById('time-index').style.display = 'block';
            }
        }
        // æ¸²æŸ“æ—¶é—´ç´¢å¼•
        function renderTimeIndex() {
            console.log("æ¸²æŸ“æ—¶é—´ç´¢å¼•"); // æ·»åŠ æ—¥å¿—
            const timeIndexContainer = document.getElementById('time-index');
            timeIndexContainer.innerHTML = '';
            
            timeIndex.forEach(item => {
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'time-link';
                link.textContent = item.displayText;
                link.dataset.index = item.firstIndex;
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    scrollToMessage(parseInt(e.target.dataset.index));
                    toggleToolbar(); // ç‚¹å‡»åå…³é—­å·¥å…·æ 
                });
                timeIndexContainer.appendChild(link);
            });
        }
        // æ»šåŠ¨åˆ°æŒ‡å®šæ¶ˆæ¯
        function scrollToMessage(index) {
            console.log("æ»šåŠ¨åˆ°æ¶ˆæ¯:", index); // æ·»åŠ æ—¥å¿—
            const messageElements = document.querySelectorAll('.message, .time-divider');
            if (messageElements[index]) {
                messageElements[index].scrollIntoView({ behavior: 'smooth' });
            } else {
                console.warn("æ‰¾ä¸åˆ°è¦æ»šåŠ¨çš„æ¶ˆæ¯:", index); // æ·»åŠ è­¦å‘Šæ—¥å¿—
            }
        }
        // æœç´¢åŠŸèƒ½
        function searchMessages(keyword) {
            console.log("æœç´¢æ¶ˆæ¯:", keyword); // æ·»åŠ æ—¥å¿—
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            
            if (!keyword) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const results = [];
            allMessages.forEach((msg, index) => {
                if (msg.content && msg.content.includes(keyword)) {
                    results.push({ index, msg });
                }
            });
            
            console.log("æ¶ˆæ¯æœç´¢ç»“æœ:", results.length); // æ·»åŠ æ—¥å¿—
            
            if (results.length > 0) {
                results.slice(0, 10).forEach(result => {
                    const resultElement = document.createElement('div');
                    resultElement.className = 'search-result';
                    resultElement.textContent = result.msg.content.substring(0, 30) + (result.msg.content.length > 30 ? '...' : '');
                    resultElement.addEventListener('click', () => {
                        scrollToMessage(result.index);
                        highlightMessage(result.index, keyword);
                        resultsContainer.style.display = 'none';
                        toggleToolbar(); // ç‚¹å‡»åå…³é—­å·¥å…·æ 
                    });
                    resultsContainer.appendChild(resultElement);
                });
                resultsContainer.style.display = 'block';
            } else {
                resultsContainer.style.display = 'none';
            }
        }
        // æ»šåŠ¨åˆ°æŒ‡å®šæ¶ˆæ¯
        function scrollToMessage(index, keyword) {
            console.log("æ»šåŠ¨åˆ°æ¶ˆæ¯å¹¶é«˜äº®:", index, keyword); // æ·»åŠ æ—¥å¿—
            const messageElements = document.querySelectorAll('.message');
            if (messageElements[index]) {
                messageElements[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
                // æ·»åŠ é«˜äº®æ•ˆæœ
                messageElements[index].classList.add('message-highlight');
                setTimeout(() => {
                    messageElements[index].classList.remove('message-highlight');
                }, 2000);
                
                // é«˜äº®å…³é”®è¯
                if (keyword) {
                    const bubble = messageElements[index].querySelector('.message-bubble');
                    if (bubble) {
                        const regex = new RegExp(`(${keyword})`, 'gi');
                        bubble.innerHTML = bubble.textContent.replace(regex, '<span class="highlight">$1</span>');
                        setTimeout(() => {
                            clearHighlights();
                        }, 2000);
                    }
                }
            } else {
                console.warn("æ‰¾ä¸åˆ°è¦æ»šåŠ¨çš„æ¶ˆæ¯:", index); // æ·»åŠ è­¦å‘Šæ—¥å¿—
            }
        }
        // æ¸…é™¤é«˜äº®
        function clearHighlights() {
            console.log("æ¸…é™¤é«˜äº®"); // æ·»åŠ æ—¥å¿—
            const highlights = document.querySelectorAll('.highlight');
            highlights.forEach(span => {
                const parent = span.parentNode;
                parent.replaceChild(document.createTextNode(span.textContent), span);
                parent.normalize();
            });
        }
        // åˆ‡æ¢å·¥å…·æ æ˜¾ç¤º/éšè—
        function toggleToolbar() {
            console.log("åˆ‡æ¢å·¥å…·æ "); // æ·»åŠ æ—¥å¿—
            const toolbar = document.getElementById('toolbar');
            const overlay = document.getElementById('overlay');
            toolbar.classList.toggle('open');
            overlay.classList.toggle('show');
        }
        document.getElementById('image-dir-button').addEventListener('click', async () => {
            try {
                imageDirectoryHandle = await window.showDirectoryPicker();
                alert('å›¾ç‰‡æ–‡ä»¶å¤¹é€‰æ‹©æˆåŠŸï¼ç°åœ¨åŠ è½½çš„èŠå¤©è®°å½•ä¸­çš„å›¾ç‰‡å°†ä»æ­¤æ–‡ä»¶å¤¹è¯»å–ã€‚');
            } catch (err) {
                console.error('é€‰æ‹©å›¾ç‰‡æ–‡ä»¶å¤¹å¤±è´¥:', err);
                alert('é€‰æ‹©å›¾ç‰‡æ–‡ä»¶å¤¹å¤±è´¥ï¼Œè¯·å…è®¸æµè§ˆå™¨è®¿é—®æ–‡ä»¶å¤¹ã€‚');
            }
        });

        document.getElementById('file-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            console.log("é€‰æ‹©æ–‡ä»¶:", file.name); // æ·»åŠ æ—¥å¿—
            
            const reader = new FileReader();
            reader.onload = async function(e) { // Make the onload function async
                console.log("[DEBUG] æ–‡ä»¶è¯»å–å®Œæˆï¼Œå¼€å§‹è§£æ JSON å†…å®¹"); // æ·»åŠ æ—¥å¿—
                const chatContainer = document.getElementById('chat-container');
                const chatHeader = document.getElementById('chat-header');
                const chatTitle = document.getElementById('chat-title');
                const fileSelector = document.getElementById('file-selector-container');
                try {
                    const messages = JSON.parse(e.target.result);
                    console.log("æ¶ˆæ¯è§£æå®Œæˆï¼Œæ¶ˆæ¯æ•°é‡:", messages.length); // æ·»åŠ æ—¥å¿—
                    allMessages = messages; // ä¿å­˜æ‰€æœ‰æ¶ˆæ¯ç”¨äºæœç´¢
                    fileSelector.style.display = 'none';
                    chatHeader.style.display = 'block';
                    document.getElementById('image-dir-button').style.display = 'block'; // Show the button after JSON is loaded
                    
                    // ä¿®æ”¹æ ‡é¢˜æ˜¾ç¤ºé€»è¾‘ï¼Œä¼˜å…ˆæ˜¾ç¤ºå¯¹æ–¹çš„åå­—
                    let chatTitleText = 'èŠå¤©è®°å½•';
                    if (messages.length > 0) {
                        // å°è¯•ä»æ¶ˆæ¯ä¸­è·å–å¯¹æ–¹çš„åå­—
                        for (let i = 0; i < messages.length; i++) {
                            if (!messages[i].isSelf && messages[i].senderName) {
                                chatTitleText = messages[i].senderName;
                                break;
                            }
                        }
                        // å¦‚æœæ²¡æ‰¾åˆ°å¯¹æ–¹åå­—ï¼Œåˆ™å°è¯•ä½¿ç”¨talkerName
                        if (chatTitleText === 'èŠå¤©è®°å½•') {
                            chatTitleText = messages[0].talkerName || 'èŠå¤©è®°å½•';
                        }
                    } else {
                        chatTitleText = 'ç©ºçš„èŠå¤©è®°å½•';
                    }
                    console.log("è®¾ç½®èŠå¤©æ ‡é¢˜:", chatTitleText); // æ·»åŠ æ—¥å¿—
                    chatTitle.textContent = chatTitleText;
                    chatContainer.innerHTML = ''; 
                    let lastTimestamp = null;
                    const TIME_GAP = 5 * 60 * 1000; // 5åˆ†é’Ÿçš„æ¯«ç§’æ•°
                    
                    let emptyMessageCount = 0; // ç»Ÿè®¡ç©ºæ¶ˆæ¯æ•°é‡
                    let processedMessageCount = 0; // ç»Ÿè®¡å¤„ç†çš„æ¶ˆæ¯æ•°é‡
                    
                    for (const msg of messages) {
                        processedMessageCount++;
                        const currentTimestamp = new Date(msg.time);
                        
                        // !!!!!! æ™ºèƒ½æ—¶é—´æˆ³çš„æ ¸å¿ƒé€»è¾‘ !!!!!!
                        if (lastTimestamp === null || (currentTimestamp - lastTimestamp) > TIME_GAP) {
                            const timeDivider = document.createElement('div');
                            timeDivider.className = 'time-divider';
                            timeDivider.innerHTML = `<a name="time-${currentTimestamp.getTime()}">${formatTimestamp(currentTimestamp)}</a>`;
                            chatContainer.appendChild(timeDivider);
                        }
                        lastTimestamp = currentTimestamp;
                        // !!!!!! æ—¶é—´æˆ³é€»è¾‘ç»“æŸ !!!!!!
                        
                        const messageDiv = document.createElement('div');
                        messageDiv.classList.add('message');
                        if (msg.isSelf) {
                            messageDiv.classList.add('self');
                        } else {
                            messageDiv.classList.add('other');
                            const senderNameDiv = document.createElement('div');
                            senderNameDiv.classList.add('sender-name');
                            senderNameDiv.textContent = msg.senderName;
                            messageDiv.appendChild(senderNameDiv);
                        }
                        
                        const bubbleDiv = await renderMessage(msg); // Use await here
                        messageDiv.appendChild(bubbleDiv);
                        chatContainer.appendChild(messageDiv);
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯ç©ºæ¶ˆæ¯
                        if (bubbleDiv.classList.contains('empty-message')) {
                            emptyMessageCount++;
                        }
                    }
                    
                    console.log("æ¶ˆæ¯æ¸²æŸ“å®Œæˆï¼Œå¤„ç†æ¶ˆæ¯æ•°:", processedMessageCount, "ç©ºæ¶ˆæ¯æ•°:", emptyMessageCount); // æ·»åŠ æ—¥å¿—
                    
                    // æ„å»ºæ—¶é—´ç´¢å¼•
                    buildTimeIndex(messages);
                } catch (error) {
                    console.error("æ–‡ä»¶è§£æå¤±è´¥:", error); // æ·»åŠ é”™è¯¯æ—¥å¿—
                    alert(`æ–‡ä»¶è§£æå¤±è´¥ï¼\né”™è¯¯ä¿¡æ¯: ${error.message}`);
                    fileSelector.style.display = 'flex';
                    chatHeader.style.display = 'none';
                    chatContainer.innerHTML = '';
                }
            };
            reader.readAsText(file, 'UTF-8');
        });
        // æ·»åŠ æœç´¢æ¡†äº‹ä»¶ç›‘å¬
        document.getElementById('search-box').addEventListener('input', function(e) {
            searchMessages(e.target.value);
        });
        // æ·»åŠ å·¥å…·æ åˆ‡æ¢æŒ‰é’®äº‹ä»¶ç›‘å¬
        document.getElementById('toolbar-toggle').addEventListener('click', toggleToolbar);
        document.getElementById('toolbar-close').addEventListener('click', toggleToolbar);
        
        // æ·»åŠ æ—¶é—´ç´¢å¼•æœç´¢æ¡†äº‹ä»¶ç›‘å¬
        document.getElementById('time-search-box').addEventListener('input', function(e) {
            searchTimeIndex(e.target.value);
        });
        
        // ç‚¹å‡»é®ç½©å±‚å…³é—­å·¥å…·æ 
        document.getElementById('overlay').addEventListener('click', toggleToolbar);
        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­æœç´¢ç»“æœ
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#search-container')) {
                document.getElementById('search-results').style.display = 'none';
            }
        });
    </script>
</body>
</html>